# Lab 11
## `kubectl secret`
```bash
[kinjalik@kinjalik-laptop core-course-labs]$ kubectl create secret generic db-user-pass --from-literal=username=admin --from-literal=password='fjklawjfwalkawjflkawjlfkajlwk'
secret/db-user-pass created
[kinjalik@kinjalik-laptop core-course-labs]$ kubectl get secrets
NAME                                      TYPE                 DATA   AGE
db-user-pass                              Opaque               2      9s
sh.helm.release.v1.kotlin-native-app.v1   helm.sh/release.v1   1      7d3h
sh.helm.release.v1.python-app.v1          helm.sh/release.v1   1      7d3h
[kinjalik@kinjalik-laptop core-course-labs]$ kubectl get secret db-user-pass -o jsonpath='{.data}'
{"password":"ZmprbGF3amZ3YWxrYXdqZmxrYXdqbGZrYWpsd2s=","username":"YWRtaW4="}[kinjalik@kinjalik-laptop core-course-labs]$ echo 'ZmprbGF3amZ3YWxrYXdqZmxrYXdqbGZrYWpsd2s=' | base64 --decode
fjklawjfwalkawjflkawjlfkajlwk
[kinjalik@kinjalik-laptop core-course-labs]$ echo 'YWRtaW4=' | base64 --decode
admin
```

## Secret in container
Unnecessary variables omitted
```bash
[kinjalik@kinjalik-laptop k8s]$ docker exec -it af6527513399 sh
/app $ env
...
USERNAME=admin
...
PASSWORD=fjklawjfwalkawjflkawjlfkajlwk
...
/app $ 
```

```bash
[kinjalik@kinjalik-laptop k8s]$ kubectl exec python-app-6c7c5b4c5c-fsxzb -- env | grep USERNAME
USERNAME=admin
```

## Injected secret
I added required annotations into the `values.yaml` because it's obviously correct place to store it.

```bash
[kinjalik@kinjalik-laptop k8s]$ kubectl exec -it python-app-687bb69cd7-4x5tq -- sh
Defaulted container "python-app" out of: python-app, vault-agent, vault-agent-init (init)
/app $ ls /vault/secrets/database-config.txt 
/vault/secrets/database-config.txt
/app $ cat /vault/secrets/database-config.txt 
db-readonly-username:db-secret-password/app $ df -h
Filesystem                Size      Used Available Use% Mounted on
overlay                 341.8G    125.2G    199.3G  39% /
tmpfs                    64.0M         0     64.0M   0% /dev
tmpfs                    15.4G      4.0K     15.4G   0% /vault/secrets
/dev/nvme0n1p4          341.8G    125.2G    199.3G  39% /dev/termination-log
/dev/nvme0n1p4          341.8G    125.2G    199.3G  39% /etc/resolv.conf
/dev/nvme0n1p4          341.8G    125.2G    199.3G  39% /etc/hostname
/dev/nvme0n1p4          341.8G    125.2G    199.3G  39% /etc/hosts
shm                      64.0M         0     64.0M   0% /dev/shm
tmpfs                    15.4G     12.0K     15.4G   0% /run/secrets/kubernetes.io/serviceaccount
tmpfs                     7.7G         0      7.7G   0% /proc/asound
tmpfs                     7.7G         0      7.7G   0% /proc/acpi
tmpfs                    64.0M         0     64.0M   0% /proc/kcore
tmpfs                    64.0M         0     64.0M   0% /proc/keys
tmpfs                    64.0M         0     64.0M   0% /proc/latency_stats
tmpfs                    64.0M         0     64.0M   0% /proc/timer_list
tmpfs                     7.7G         0      7.7G   0% /proc/scsi
tmpfs                     7.7G         0      7.7G   0% /sys/firmware
/app $ 
```
## Resource limit
Perfectly, I'd like to declare such limits using `--set` flag for `helm install`, but to make it explicit I declared it directly in the chart

### Python app
some unnecessary data omitted
```bash
[kinjalik@kinjalik-laptop k8s]$ kubectl describe po python-app-5b85cb7c8c-htftr 
Name:             python-app-5b85cb7c8c-htftr
Namespace:        default
Priority:         0
Service Account:  python-app
Node:             minikube/192.168.49.2
Start Time:       Mon, 13 Nov 2023 21:59:02 +0300
Labels:           app.kubernetes.io/instance=python-app
                  app.kubernetes.io/managed-by=Helm
                  app.kubernetes.io/name=python-app
                  app.kubernetes.io/version=1.16.0
                  custom=this_is_custom_label
                  pod-template-hash=5b85cb7c8c
...
Init Containers:
  vault-agent-init:
...
    Restart Count:  0
    Limits:
      cpu:     500m
      memory:  128Mi
    Requests:
      cpu:     250m
      memory:  64Mi
...
Containers:
  python-app:
    Container ID:   docker://61583ebd5d52ff161cc81be734c92185b27b677fccadad939d38af77bb26be28
    Image:          kinjalik/devops-course-app:python
    Image ID:       docker-pullable://kinjalik/devops-course-app@sha256:c2a18318e365d77692ec0dbf3b959df246dd5111464b11ac3eb1a3e890fee3f1
...
    Restart Count:  0
    Limits:
      cpu:     100m
      memory:  128Mi
    Requests:
      cpu:      100m
      memory:   128Mi
...
  vault-agent:
    Container ID:  docker://e876259e88e2db9b261f47b7a6dcd648ce6afbb67e969e96ed4de54123af4abc
    Image:         hashicorp/vault:1.15.1
    Image ID:      docker-pullable://hashicorp/vault@sha256:6a96634beeda3f989a4d9d85a951fe835fe8504e4dae5b46610f7c4104e8388b
...
    Limits:
      cpu:     500m
      memory:  128Mi
    Requests:
      cpu:     250m
      memory:  64Mi
```

### Kotlin native app
As usual, unnecessary data omitted
```bash
Name:             kotlin-native-app-78756b8df6-q5dh6
Namespace:        default
Priority:         0
Service Account:  kotlin-native-app
Node:             minikube/192.168.49.2
Start Time:       Mon, 13 Nov 2023 21:59:14 +0300
Labels:           app.kubernetes.io/instance=kotlin-native-app
                  app.kubernetes.io/managed-by=Helm
                  app.kubernetes.io/name=kotlin-native-app
                  app.kubernetes.io/version=1.16.0
                  custom=this_is_custom_label
                  pod-template-hash=78756b8df6
Annotations:      <none>
Status:           Running
IP:               10.244.0.96
IPs:
  IP:           10.244.0.96
Controlled By:  ReplicaSet/kotlin-native-app-78756b8df6
Containers:
  kotlin-native-app:
    Container ID:   docker://807414a38b1ad99251067c33b39eff60441bd60a47f0075ff130ad85ed720b65
    Image:          kinjalik/devops-course-app:kotlin-native
    Image ID:       docker-pullable://kinjalik/devops-course-app@sha256:22fed002b71631ec8880edb80ab8c4862ff2da003805bb56f64da82991a9da76
    Port:           8080/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Mon, 13 Nov 2023 21:59:16 +0300
    Ready:          True
    Restart Count:  0
    Limits:
      cpu:     100m
      memory:  128Mi
    Requests:
      cpu:        100m
      memory:     128Mi
...
```

## Custom env vars in helper
### Python App
```bash
[kinjalik@kinjalik-laptop k8s]$ kubectl exec -it python-app-6ff9459f87-trwk9 -- printenv | grep CUSTOM
Defaulted container "python-app" out of: python-app, vault-agent, vault-agent-init (init)
FIRST_CUSTOM_VAR=PYTHON_VALUE_ONE
SECOND_CUSTOM_VAR=PYTHON_VALUE_TWO
```

### Kotlin Native app
Since Kotlin app works in distroless container, it don't have anything like `printenv`, `env` and so on.
Therefore, I'd like to use approach from another side - use `docker inspect` to know which variables it injects into container.
```bash
[kinjalik@kinjalik-laptop k8s]$ docker inspect d64604404851 | grep CUSTOM
                "FIRST_CUSTOM_VAR=KOTLIN-NATIVE_VALUE_ONE",
                "SECOND_CUSTOM_VAR=KOTLIN-NATIVE_VALUE_TWO",
```